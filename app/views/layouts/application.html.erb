<!DOCTYPE html>
<!--[if IE 8 ]> <html lang="en" class="ie8"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en"><!--<![endif]-->
<head>
	<!-- %meta{:content => "IE=edge,chrome=1", "http-equiv" => "X-UA-Compatible"} -->
  <title>Mycelial</title>
  <%= stylesheet_link_tag    "application", media: "all" %>

  <%= javascript_include_tag "application" %>
  <script src="http://js.pusherapp.com/1.9/pusher.min.js"></script>

  <%= csrf_meta_tags %>

  <% if Rails.env.production? %>
  	<script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>

  	<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-37234083-1']);
		  _gaq.push(['_setDomainName', 'mycelial.com']);
		  _gaq.push(['_setAllowLinker', true]);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

		</script>
  <% end %>

  <% if signed_in? %>
	  <script type="text/javascript" charset="utf-8">	

	  	<% if Rails.env.development? %> 
	    Pusher.log = function(message) {
	      if (window.console && window.console.log) window.console.log(message);
	    };
	    <% end %>

	    $(function() {
	      var pusher = new Pusher('<%= Pusher.key %>'); 
	      var channel = pusher.subscribe('private-'+<%= current_user ? current_user.id : 'null' %>);

	      channel.bind('new_notification', function(data) {
	  			msg = 'new messages';
	  			dom_notify(msg);
				});

				function title_notify(msg) {
	  			$.titleAlert(msg);
				}

				function dom_notify(msg) {
				  $('#notify').fadeIn();
				  title_notify('New Messages');
				}
		  });
	  </script>
  <% end %>
</head>
<body>
    <%= yield %>
    <% unless controller?('home') or @no_bottom_navbar %>
    <div class="navbar navbar-fixed-bottom mycelial_bottom_navbar">
      <div class="navbar-inner mycelial_inner">
      	<div class="align_center mycelial_nav">
          <div class="nav">
            <ul class="nav mycelial_nav">
            	<li><a href="/">mycelial</a></li>
              <li <%= controller?('feed') ? "class=active" : "" %>><%= link_to "Feed", feed_path %></li>
              <% if user_signed_in? %>
	              <li <%= on_own_page?(params[:id]) && !action?('edit') ? "class=active" : "" %>><%= link_to "Profile", page_path(:id => current_user.username) %></li>
	              <li <%= action?('edit') ? "class=active" : "" %>><%= link_to "Admin", edit_page_path(:id => current_user.page.id) %></li>
	              <li><%= link_to 'Logout', destroy_user_session_path, method: :delete %></li>
              <% else %>
	              <li><%= link_to "Create Your Page", new_user_registration_path %></li>
								<li><%= link_to "Login", new_user_session_path %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <% end %>
    <% if Rails.env.production? %>
    	<script type="text/javascript">
			  var _sf_async_config = { uid: 35198, domain: 'mycelial.com' };
			  (function() {
			    function loadChartbeat() {
			      window._sf_endpt = (new Date()).getTime();
			      var e = document.createElement('script');
			      e.setAttribute('language', 'javascript');
			      e.setAttribute('type', 'text/javascript');
			      e.setAttribute('src',
			        (("https:" == document.location.protocol) ? "https://a248.e.akamai.net/chartbeat.download.akamai.com/102508/" : "http://static.chartbeat.com/") +
			        "js/chartbeat.js");
			      document.body.appendChild(e);
			    };
			    var oldonload = window.onload;
			    window.onload = (typeof window.onload != 'function') ?
			      loadChartbeat : function() { oldonload(); loadChartbeat(); };
			  })();
			</script>
    <% end %>
</body>
</html>
